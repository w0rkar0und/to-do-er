<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do-Er - Weekly Task Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            
            --bg-primary: #0f0f23;
            --bg-secondary: #16213e;
            --bg-tertiary: #1a2332;
            --surface: rgba(255, 255, 255, 0.1);
            --surface-hover: rgba(255, 255, 255, 0.15);
            --text-primary: #ffffff;
            --text-secondary: #a8b2d1;
            --text-muted: #6c7293;
            
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 16px 60px rgba(0, 0, 0, 0.3);
            
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --border-radius-lg: 24px;
        }

        body {
            font-family: 'Playfair Display', Georgia, 'Times New Roman', serif;
            background: var(--bg-primary);
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.1) 0%, transparent 50%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            letter-spacing: -0.01em;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .header {
            background: var(--surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-lg);
            padding: 32px;
            margin-bottom: 40px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }

        .week-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            gap: 20px;
        }

        .week-nav button {
            background: var(--primary-gradient);
            color: var(--text-primary);
            border: none;
            padding: 14px 28px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .week-nav button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .week-nav button:hover::before {
            left: 100%;
        }

        .week-nav button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }

        .week-nav button:active {
            transform: translateY(0) scale(0.98);
        }

        .week-nav button:disabled {
            background: linear-gradient(135deg, #6c7293 0%, #4a4d63 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: var(--shadow-sm);
        }

        .week-info {
            text-align: center;
            flex: 1;
        }

        .week-info h1 {
            font-size: 2.5em;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #fff 0%, #a8b2d1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
            letter-spacing: -0.02em;
        }

        .week-info p {
            font-size: 1.1em;
            color: var(--text-secondary);
            font-weight: 500;
            letter-spacing: 0.01em;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-top: 40px;
        }

        .day-column {
            background: var(--surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            position: relative;
        }

        .day-column::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }

        .day-column:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .day-column.collapsed {
            min-height: auto;
        }

        .day-column.expanded {
            min-height: 400px;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
            position: relative;
            background: rgba(255, 255, 255, 0.05);
        }

        .day-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 24px;
            right: 24px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }

        .day-header:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .day-header-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .day-title {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .day-date {
            font-size: 0.9em;
            color: var(--text-muted);
            font-weight: 500;
            letter-spacing: 0.01em;
        }

        .day-header-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .task-count {
            background: var(--success-gradient);
            color: var(--text-primary);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-sm);
        }

        .task-count.has-tasks {
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
        }

        .collapse-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 1.2em;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--border-radius-sm);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .collapse-toggle:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-primary);
            transform: scale(1.05);
            box-shadow: var(--shadow-sm);
        }

        .collapse-toggle.collapsed {
            transform: rotate(-90deg) scale(1.05);
        }

        .day-content {
            padding: 24px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }

        .day-column.collapsed .day-content {
            max-height: 0;
            padding: 0 24px;
            opacity: 0;
        }

        .day-column.expanded .day-content {
            max-height: 2000px;
            opacity: 1;
        }

        .add-task-section {
            margin-bottom: 24px;
        }

        .add-task-input {
            display: flex;
            gap: 12px;
        }

        .add-task-input input {
            flex: 1;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--border-radius);
            font-size: 15px;
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .add-task-input input::placeholder {
            color: var(--text-muted);
        }

        .add-task-input input:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.5);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .add-task-input button {
            background: var(--warning-gradient);
            color: var(--text-primary);
            border: none;
            padding: 16px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .add-task-input button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .add-task-input button:hover::before {
            left: 100%;
        }

        .add-task-input button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: var(--shadow-xl);
        }

        .add-task-input button:active {
            transform: translateY(0) scale(0.98);
        }

        .tasks-list {
            min-height: 120px;
        }

        .task-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: grab;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .task-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: var(--success-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .task-item:hover {
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            background: rgba(255, 255, 255, 0.08);
        }

        .task-item:hover::before {
            opacity: 1;
        }

        .task-item.dragging {
            opacity: 0.7;
            transform: rotate(2deg) scale(0.98);
            box-shadow: var(--shadow-xl);
        }

        .day-column.drag-over {
            background: rgba(67, 233, 123, 0.05);
            border-color: rgba(67, 233, 123, 0.3);
            box-shadow: 0 0 0 2px rgba(67, 233, 123, 0.1);
        }

        .day-column.drag-over.collapsed {
            animation: expandHint 0.5s ease;
        }

        @keyframes expandHint {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .task-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
            word-wrap: break-word;
            line-height: 1.4;
            letter-spacing: -0.01em;
        }

        .task-title.completed {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .task-notes {
            color: var(--text-secondary);
            font-size: 0.9em;
            font-style: italic;
            margin-bottom: 16px;
            word-wrap: break-word;
            line-height: 1.5;
            letter-spacing: 0.005em;
        }

        .progress-container {
            margin-bottom: 16px;
        }

        .progress-label {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: var(--warning-gradient);
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .progress-fill.completed {
            background: var(--success-gradient);
        }

        .task-controls {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-sm {
            padding: 3px 8px;
            font-size: 10px;
        }

        .btn-progress {
            background: #f39c12;
            color: white;
        }

        .btn-progress:hover {
            background: #e67e22;
        }

        .btn-complete {
            background: #27ae60;
            color: white;
        }

        .btn-complete:hover {
            background: #229954;
        }

        .btn-incomplete {
            background: #95a5a6;
            color: white;
        }

        .btn-incomplete:hover {
            background: #7f8c8d;
        }

        .btn-edit {
            background: #3498db;
            color: white;
        }

        .btn-edit:hover {
            background: #2980b9;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-delete:hover {
            background: #c0392b;
        }

        .btn-save {
            background: #27ae60;
            color: white;
        }

        .btn-cancel {
            background: #95a5a6;
            color: white;
        }

        .progress-input {
            width: 50px;
            padding: 3px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 11px;
        }

        .edit-form {
            display: none;
            margin-top: 10px;
        }

        .edit-form input, .edit-form textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #e1e8ed;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .edit-form textarea {
            resize: vertical;
            min-height: 60px;
        }

        .empty-day {
            text-align: center;
            color: #bdc3c7;
            font-style: italic;
            padding: 40px 20px;
        }

        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            display: none;
            z-index: 1000;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Day-specific color themes */
        .day-monday .day-header { border-bottom-color: #e74c3c; }
        .day-monday .task-count { background: #e74c3c; }
        
        .day-tuesday .day-header { border-bottom-color: #f39c12; }
        .day-tuesday .task-count { background: #f39c12; }
        
        .day-wednesday .day-header { border-bottom-color: #f1c40f; }
        .day-wednesday .task-count { background: #f1c40f; }
        
        .day-thursday .day-header { border-bottom-color: #27ae60; }
        .day-thursday .task-count { background: #27ae60; }
        
        .day-friday .day-header { border-bottom-color: #3498db; }
        .day-friday .task-count { background: #3498db; }
        
        .day-weekend .day-header { border-bottom-color: #9b59b6; }
        .day-weekend .task-count { background: #9b59b6; }

        /* Collapsed state styling */
        .day-column.collapsed .day-header {
            border-bottom: none;
        }

        .day-column.collapsed {
            min-height: auto;
        }

        /* Animation for expanding sections */
        .day-column.expanding .day-content {
            animation: expandSection 0.3s ease forwards;
        }

        @keyframes expandSection {
            from {
                max-height: 0;
                opacity: 0;
            }
            to {
                max-height: 2000px;
                opacity: 1;
            }
        }

        @media (max-width: 1200px) {
            .days-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            :root {
                --border-radius: 12px;
                --border-radius-sm: 6px;
                --border-radius-lg: 18px;
            }

            .container {
                padding: 20px 16px;
            }

            .header {
                padding: 24px 20px;
                margin-bottom: 32px;
            }

            .week-nav {
                flex-direction: column;
                gap: 16px;
            }

            .week-nav button {
                width: 100%;
                padding: 16px 24px;
                font-size: 16px;
            }

            .week-info h1 {
                font-size: 2.2em;
            }

            .days-grid {
                grid-template-columns: 1fr;
                gap: 20px;
                margin-top: 32px;
            }

            .day-content {
                padding: 20px;
            }

            .day-column.collapsed .day-content {
                padding: 0 20px;
            }

            .day-header {
                padding: 20px;
            }

            .day-header-info {
                gap: 12px;
            }

            .day-title {
                font-size: 1.3em;
            }

            .task-item {
                padding: 16px;
            }

            .task-controls {
                justify-content: center;
                gap: 10px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }

            .add-task-input {
                gap: 10px;
            }

            .add-task-input input,
            .add-task-input button {
                padding: 14px 18px;
                font-size: 15px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px 12px;
            }

            .header {
                padding: 20px 16px;
                margin-bottom: 28px;
            }

            .week-info h1 {
                font-size: 1.9em;
            }

            .week-info p {
                font-size: 1em;
            }

            .day-header {
                padding: 16px;
            }

            .day-content {
                padding: 16px;
            }

            .day-column.collapsed .day-content {
                padding: 0 16px;
            }

            .day-header-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }

            .day-title {
                font-size: 1.2em;
            }

            .day-date {
                font-size: 0.8em;
            }

            .add-task-input {
                flex-direction: column;
                gap: 12px;
            }

            .add-task-input input, 
            .add-task-input button {
                padding: 16px 20px;
                font-size: 16px;
            }

            .task-controls {
                flex-direction: column;
                gap: 8px;
            }

            .btn {
                width: 100%;
                padding: 12px 20px;
                font-size: 14px;
            }

            .progress-input {
                width: 80px;
                padding: 10px 14px;
                font-size: 14px;
            }

            .task-title {
                font-size: 1.05em;
            }

            .task-notes {
                font-size: 0.85em;
            }

            .copy-mode-indicator {
                padding: 16px 24px;
                font-size: 14px;
                max-width: 280px;
                text-align: center;
            }

            .debug-info {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                font-size: 10px;
            }
        }

        @media (max-width: 320px) {
            .week-info h1 {
                font-size: 1.7em;
            }

            .task-item {
                padding: 12px;
            }

            .day-header {
                padding: 12px;
            }

            .day-content {
                padding: 12px;
            }

            .day-column.collapsed .day-content {
                padding: 0 12px;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --surface: rgba(255, 255, 255, 0.15);
                --surface-hover: rgba(255, 255, 255, 0.25);
            }

            .day-column,
            .task-item {
                border-color: rgba(255, 255, 255, 0.3);
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Touch device optimizations */
        @media (pointer: coarse) {
            .btn {
                min-height: 44px;
                min-width: 44px;
            }

            .collapse-toggle {
                min-height: 44px;
                min-width: 44px;
            }

            .task-count {
                min-height: 36px;
                min-width: 36px;
            }
        }
    </style>
</head>
<body>
    <div class="debug-info" id="debugInfo"></div>
    <div class="copy-mode-indicator" id="copyModeIndicator">
        Click on a day to copy the task there
    </div>
    
    <div class="container">
        <div class="header">
            <div class="week-nav">
                <button id="prevWeek">&larr; Previous Week</button>
                <div class="week-info">
                    <h1 id="weekTitle">Week 34, 2025</h1>
                    <p id="weekDates">Aug 18 - Aug 24, 2025</p>
                </div>
                <button id="nextWeek">Next Week &rarr;</button>
            </div>
        </div>

        <div class="days-grid" id="daysGrid">
            <!-- Days will be populated by JavaScript -->
        </div>
    </div>

    <script>
        class TodoApp {
            constructor() {
                this.currentWeek = null;
                this.currentYear = null;
                this.tasks = {};
                this.collapsedSections = {};
                this.debugMode = false;
                this.days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'weekend'];
                this.dayNames = {
                    monday: 'Monday',
                    tuesday: 'Tuesday', 
                    wednesday: 'Wednesday',
                    thursday: 'Thursday',
                    friday: 'Friday',
                    weekend: 'Weekend'
                };
                
                this.init();
                this.bindEvents();
                this.loadCurrentWeek();
                this.renderDays();
                this.renderAllTasks();
                this.attachTaskEventListeners(); // Ensure event listeners are attached
                this.applyCollapsedStates();
                
                this.log('TodoApp with auto-expanding daily sections initialized successfully');
            }

            log(message, data = null) {
                console.log(`[TodoApp] ${message}`, data || '');
                if (this.debugMode) {
                    const debugEl = document.getElementById('debugInfo');
                    debugEl.style.display = 'block';
                    const time = new Date().toLocaleTimeString();
                    debugEl.innerHTML += `${time}: ${message}<br>`;
                    debugEl.scrollTop = debugEl.scrollHeight;
                }
            }

            init() {
                // Load tasks from localStorage
                try {
                    const saved = localStorage.getItem('todoer-tasks-daily');
                    if (saved) {
                        this.tasks = JSON.parse(saved);
                        this.log('Daily tasks loaded from localStorage', this.tasks);
                    } else {
                        // Check for old format and migrate
                        const oldSaved = localStorage.getItem('todoer-tasks');
                        if (oldSaved) {
                            this.migrateLegacyData(JSON.parse(oldSaved));
                            this.log('Migrated legacy task data to daily format');
                        }
                    }
                } catch (e) {
                    this.log('Error loading tasks from localStorage', e);
                    this.tasks = {};
                }

                // Load collapsed sections state
                try {
                    const savedCollapsed = localStorage.getItem('todoer-collapsed-sections');
                    if (savedCollapsed) {
                        this.collapsedSections = JSON.parse(savedCollapsed);
                        this.log('Collapsed sections loaded from localStorage', this.collapsedSections);
                    }
                } catch (e) {
                    this.log('Error loading collapsed sections', e);
                    this.collapsedSections = {};
                }

                // Enable debug mode with Ctrl+Shift+D
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                        this.debugMode = !this.debugMode;
                        document.getElementById('debugInfo').style.display = 
                            this.debugMode ? 'block' : 'none';
                        this.log(`Debug mode ${this.debugMode ? 'enabled' : 'disabled'}`);
                    }
                });
            }

            migrateLegacyData(oldTasks) {
                // Convert old format {weekKey: [tasks]} to new format {weekKey: {day: [tasks]}}
                for (const [weekKey, tasks] of Object.entries(oldTasks)) {
                    if (Array.isArray(tasks)) {
                        // Distribute old tasks to Monday by default
                        this.tasks[weekKey] = {
                            monday: tasks,
                            tuesday: [],
                            wednesday: [],
                            thursday: [],
                            friday: [],
                            weekend: []
                        };
                    }
                }
                this.saveTasks();
            }

            bindEvents() {
                document.getElementById('prevWeek').addEventListener('click', () => this.navigateWeek(-1));
                document.getElementById('nextWeek').addEventListener('click', () => this.navigateWeek(1));
            }

            getWeekNumber(date) {
                // ISO week calculation (Monday start)
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
                const week1 = new Date(d.getFullYear(), 0, 4);
                const weekNum = 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
                return { week: weekNum, year: d.getFullYear() };
            }

            getWeekDates(year, week) {
                const jan4 = new Date(year, 0, 4);
                const startOfWeek = new Date(jan4.getTime() + (week - 1) * 7 * 24 * 60 * 60 * 1000);
                startOfWeek.setDate(startOfWeek.getDate() - ((jan4.getDay() + 6) % 7));
                
                const dates = {};
                const dayNames = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
                
                dayNames.forEach((day, index) => {
                    const date = new Date(startOfWeek);
                    date.setDate(date.getDate() + index);
                    dates[day] = date;
                });
                
                // Weekend combines Saturday and Sunday
                const saturday = new Date(startOfWeek);
                saturday.setDate(saturday.getDate() + 5);
                const sunday = new Date(startOfWeek);
                sunday.setDate(sunday.getDate() + 6);
                dates.weekend = { start: saturday, end: sunday };
                
                return dates;
            }

            loadCurrentWeek() {
                const now = new Date();
                const weekInfo = this.getWeekNumber(now);
                this.currentWeek = weekInfo.week;
                this.currentYear = weekInfo.year;
                this.updateWeekDisplay();
                this.log(`Current week loaded: Week ${this.currentWeek}, ${this.currentYear}`);
            }

            navigateWeek(direction) {
                this.currentWeek += direction;
                
                // Handle year transitions
                if (this.currentWeek < 1) {
                    this.currentYear--;
                    this.currentWeek = 52; // Approximate, ISO weeks can vary
                } else if (this.currentWeek > 52) {
                    this.currentYear++;
                    this.currentWeek = 1;
                }
                
                this.updateWeekDisplay();
                this.renderDays();
                this.renderAllTasks();
                this.applyCollapsedStates();
                this.log(`Navigated to Week ${this.currentWeek}, ${this.currentYear}`);
            }

            updateWeekDisplay() {
                const dates = this.getWeekDates(this.currentYear, this.currentWeek);
                const title = `Week ${this.currentWeek}, ${this.currentYear}`;
                const dateRange = `${dates.monday.toLocaleDateString('en-GB', { 
                    month: 'short', day: 'numeric' 
                })} - ${dates.weekend.end.toLocaleDateString('en-GB', { 
                    month: 'short', day: 'numeric' 
                })}, ${this.currentYear}`;
                
                document.getElementById('weekTitle').textContent = title;
                document.getElementById('weekDates').textContent = dateRange;
            }

            getWeekKey() {
                return `${this.currentYear}-W${String(this.currentWeek).padStart(2, '0')}`;
            }

            getCollapsedKey(day) {
                return `${this.getWeekKey()}-${day}`;
            }

            isDayCollapsed(day) {
                const key = this.getCollapsedKey(day);
                const tasks = this.getTasksForDay(day);
                
                // If manually collapsed, respect that
                if (this.collapsedSections[key] !== undefined) {
                    return this.collapsedSections[key];
                }
                
                // Auto-collapse empty sections
                return tasks.length === 0;
            }

            toggleDayCollapse(day) {
                const key = this.getCollapsedKey(day);
                const currentlyCollapsed = this.isDayCollapsed(day);
                
                this.collapsedSections[key] = !currentlyCollapsed;
                this.saveCollapsedState();
                this.applyCollapsedState(day);
                
                this.log(`Day ${day} ${currentlyCollapsed ? 'expanded' : 'collapsed'}`);
            }

            expandDay(day) {
                const key = this.getCollapsedKey(day);
                if (this.isDayCollapsed(day)) {
                    this.collapsedSections[key] = false;
                    this.saveCollapsedState();
                    this.applyCollapsedState(day, true); // true for animation
                    this.log(`Day ${day} auto-expanded`);
                }
            }

            applyCollapsedStates() {
                this.days.forEach(day => {
                    this.applyCollapsedState(day);
                });
            }

            applyCollapsedState(day, animate = false) {
                const dayColumn = document.querySelector(`.day-${day}`);
                const toggle = document.querySelector(`.day-${day} .collapse-toggle`);
                
                if (!dayColumn || !toggle) return;
                
                const collapsed = this.isDayCollapsed(day);
                
                if (animate && !collapsed) {
                    dayColumn.classList.add('expanding');
                    setTimeout(() => dayColumn.classList.remove('expanding'), 300);
                }
                
                dayColumn.classList.toggle('collapsed', collapsed);
                dayColumn.classList.toggle('expanded', !collapsed);
                toggle.classList.toggle('collapsed', collapsed);
                toggle.innerHTML = collapsed ? '▶' : '▼';
                toggle.title = collapsed ? 'Expand section' : 'Collapse section';
            }

            saveCollapsedState() {
                try {
                    localStorage.setItem('todoer-collapsed-sections', JSON.stringify(this.collapsedSections));
                    this.log('Collapsed sections saved to localStorage');
                } catch (e) {
                    this.log('Error saving collapsed sections', e);
                }
            }

            renderDays() {
                const grid = document.getElementById('daysGrid');
                const dates = this.getWeekDates(this.currentYear, this.currentWeek);
                
                grid.innerHTML = this.days.map(day => {
                    const dayTasks = this.getTasksForDay(day);
                    let dateDisplay;
                    
                    if (day === 'weekend') {
                        dateDisplay = `${dates[day].start.toLocaleDateString('en-GB', { 
                            day: 'numeric', month: 'short' 
                        })} - ${dates[day].end.toLocaleDateString('en-GB', { 
                            day: 'numeric', month: 'short' 
                        })}`;
                    } else {
                        dateDisplay = dates[day].toLocaleDateString('en-GB', { 
                            day: 'numeric', month: 'short' 
                        });
                    }
                    
                    return `
                        <div class="day-column day-${day} expanded" data-day="${day}">
                            <div class="day-header" onclick="app.toggleDayCollapse('${day}')">
                                <div class="day-header-info">
                                    <div>
                                        <div class="day-title">${this.dayNames[day]}</div>
                                        <div class="day-date">${dateDisplay}</div>
                                    </div>
                                </div>
                                <div class="day-header-controls">
                                    <div class="task-count ${dayTasks.length > 0 ? 'has-tasks' : ''}">${dayTasks.length}</div>
                                    <button class="collapse-toggle" title="Collapse section" onclick="event.stopPropagation(); app.toggleDayCollapse('${day}')">▼</button>
                                </div>
                            </div>
                            
                            <div class="day-content">
                                <div class="add-task-section">
                                    <div class="add-task-input">
                                        <input type="text" id="newTask-${day}" placeholder="Add task...">
                                        <button onclick="event.stopPropagation(); app.addTask('${day}')">Add</button>
                                    </div>
                                </div>
                                
                                <div class="tasks-list" id="tasks-${day}">
                                    <!-- Tasks will be populated here -->
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Bind enter key events for all inputs
                this.days.forEach(day => {
                    const input = document.getElementById(`newTask-${day}`);
                    if (input) {
                        input.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') this.addTask(day);
                        });
                    }
                });
                
                this.setupDragAndDrop();
                this.attachTaskEventListeners(); // Add event listeners for buttons
                this.log('Days rendered with collapse/expand functionality');
            }

            setupDragAndDrop() {
                // Make task items draggable
                document.addEventListener('dragstart', (e) => {
                    if (e.target.classList.contains('task-item')) {
                        e.target.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', e.target.dataset.taskId);
                        e.dataTransfer.setData('source-day', e.target.closest('.day-column').dataset.day);
                    }
                });

                document.addEventListener('dragend', (e) => {
                    if (e.target.classList.contains('task-item')) {
                        e.target.classList.remove('dragging');
                    }
                });

                // Handle drag over day columns
                document.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const dayColumn = e.target.closest('.day-column');
                    if (dayColumn) {
                        dayColumn.classList.add('drag-over');
                        
                        // Auto-expand collapsed sections when dragging over them
                        const day = dayColumn.dataset.day;
                        if (this.isDayCollapsed(day)) {
                            setTimeout(() => {
                                if (dayColumn.classList.contains('drag-over')) {
                                    this.expandDay(day);
                                }
                            }, 1000); // Expand after 1 second of hovering
                        }
                    }
                });

                document.addEventListener('dragleave', (e) => {
                    const dayColumn = e.target.closest('.day-column');
                    if (dayColumn && !dayColumn.contains(e.relatedTarget)) {
                        dayColumn.classList.remove('drag-over');
                    }
                });

                // Handle drop
                document.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const dayColumn = e.target.closest('.day-column');
                    if (dayColumn) {
                        dayColumn.classList.remove('drag-over');
                        const taskId = e.dataTransfer.getData('text/plain');
                        const sourceDay = e.dataTransfer.getData('source-day');
                        const targetDay = dayColumn.dataset.day;
                        
                        if (sourceDay !== targetDay) {
                            this.expandDay(targetDay); // Ensure target day is expanded
                            this.moveTask(taskId, sourceDay, targetDay);
                        }
                    }
                });
            }

            moveTask(taskId, sourceDay, targetDay) {
                const weekKey = this.getWeekKey();
                if (!this.tasks[weekKey]) return;

                const sourceTasks = this.tasks[weekKey][sourceDay] || [];
                const taskIndex = sourceTasks.findIndex(task => task.id === taskId);
                
                if (taskIndex === -1) return;

                const task = sourceTasks.splice(taskIndex, 1)[0];
                
                if (!this.tasks[weekKey][targetDay]) {
                    this.tasks[weekKey][targetDay] = [];
                }
                
                this.tasks[weekKey][targetDay].push(task);
                
                this.saveTasks();
                this.renderAllTasks();
                this.updateAllTaskCounts();
                
                // Update collapsed states after task counts change
                this.applyCollapsedStates();
                
                this.log(`Task moved from ${sourceDay} to ${targetDay}`, { taskId, task: task.title });
            }

            getTasksForDay(day) {
                const weekKey = this.getWeekKey();
                return this.tasks[weekKey]?.[day] || [];
            }

            addTask(day) {
                // Exit copy mode when adding tasks
                if (this.copyMode) {
                    this.exitCopyMode();
                }
                
                const input = document.getElementById(`newTask-${day}`);
                const title = input.value.trim();
                
                if (!title) {
                    this.log(`Empty task title for ${day}, not adding`);
                    return;
                }
                
                // Auto-expand the day when adding a task
                this.expandDay(day);
                
                const weekKey = this.getWeekKey();
                if (!this.tasks[weekKey]) {
                    this.tasks[weekKey] = {};
                    this.days.forEach(d => this.tasks[weekKey][d] = []);
                }
                
                if (!this.tasks[weekKey][day]) {
                    this.tasks[weekKey][day] = [];
                }
                
                const task = {
                    id: Date.now().toString(),
                    title,
                    notes: '',
                    progress: 0,
                    completed: false,
                    createdAt: new Date().toISOString()
                };
                
                this.tasks[weekKey][day].push(task);
                this.saveTasks();
                this.renderTasksForDay(day);
                this.updateTaskCount(day);
                
                input.value = '';
                this.log(`Task added to ${day}`, task);
            }

            deleteTask(day, taskId) {
                this.log(`Attempting to delete task ${taskId} from ${day}`);
                
                const weekKey = this.getWeekKey();
                this.log(`Week key: ${weekKey}`);
                
                if (!this.tasks[weekKey]) {
                    this.log(`No tasks found for week ${weekKey}`);
                    return;
                }
                
                if (!this.tasks[weekKey][day]) {
                    this.log(`No tasks found for ${day} in week ${weekKey}`);
                    return;
                }
                
                const beforeCount = this.tasks[weekKey][day].length;
                this.log(`Tasks before deletion: ${beforeCount}`);
                
                this.tasks[weekKey][day] = this.tasks[weekKey][day].filter(task => task.id !== taskId);
                
                const afterCount = this.tasks[weekKey][day].length;
                this.log(`Tasks after deletion: ${afterCount}`);
                
                if (beforeCount === afterCount) {
                    this.log(`Warning: No task was deleted. Task ID ${taskId} not found.`);
                    alert(`Task not found. Please refresh the page.`);
                    return;
                }
                
                this.saveTasks();
                this.renderTasksForDay(day);
                this.updateTaskCount(day);
                
                // Re-apply collapsed state in case section should auto-collapse
                setTimeout(() => this.applyCollapsedState(day), 100);
                
                this.log(`Task successfully deleted from ${day}: ${taskId}`);
            }

            updateTask(day, taskId, updates) {
                const weekKey = this.getWeekKey();
                if (!this.tasks[weekKey] || !this.tasks[weekKey][day]) return;
                
                const task = this.tasks[weekKey][day].find(t => t.id === taskId);
                if (task) {
                    Object.assign(task, updates);
                    this.saveTasks();
                    this.renderTasksForDay(day);
                    this.log(`Task updated in ${day}: ${taskId}`, updates);
                }
            }

            toggleComplete(day, taskId) {
                const weekKey = this.getWeekKey();
                const task = this.tasks[weekKey]?.[day]?.find(t => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                    task.progress = task.completed ? 100 : task.progress;
                    this.saveTasks();
                    this.renderTasksForDay(day);
                    this.log(`Task toggled in ${day}: ${taskId}, completed: ${task.completed}`);
                }
            }

            updateProgress(day, taskId, progress) {
                const weekKey = this.getWeekKey();
                const task = this.tasks[weekKey]?.[day]?.find(t => t.id === taskId);
                if (task) {
                    task.progress = Math.max(0, Math.min(100, parseInt(progress) || 0));
                    task.completed = task.progress === 100;
                    this.saveTasks();
                    this.renderTasksForDay(day);
                    this.log(`Progress updated in ${day}: ${taskId}, progress: ${task.progress}%`);
                }
            }

            editTask(day, taskId, newTitle, newNotes) {
                this.updateTask(day, taskId, {
                    title: newTitle.trim(),
                    notes: newNotes.trim()
                });
            }

            updateTaskCount(day) {
                const tasks = this.getTasksForDay(day);
                const countEl = document.querySelector(`.day-${day} .task-count`);
                if (countEl) {
                    countEl.textContent = tasks.length;
                    countEl.classList.toggle('has-tasks', tasks.length > 0);
                }
            }

            updateAllTaskCounts() {
                this.days.forEach(day => this.updateTaskCount(day));
            }

            saveTasks() {
                try {
                    localStorage.setItem('todoer-tasks-daily', JSON.stringify(this.tasks));
                    this.log('Daily tasks saved to localStorage');
                } catch (e) {
                    this.log('Error saving tasks', e);
                    alert('Failed to save tasks. Storage might be full.');
                }
            }

            renderAllTasks() {
                this.days.forEach(day => {
                    this.renderTasksForDayInternal(day);
                    this.updateTaskCount(day);
                });
                // Attach event listeners once after all tasks are rendered
                this.attachTaskEventListeners();
            }

            renderTasksForDay(day) {
                this.renderTasksForDayInternal(day);
                // Attach event listeners after rendering individual day
                this.attachTaskEventListeners();
            }

            renderTasksForDayInternal(day) {
                const tasks = this.getTasksForDay(day);
                const container = document.getElementById(`tasks-${day}`);
                
                if (!container) return;
                
                if (tasks.length === 0) {
                    container.innerHTML = '<div class="empty-day">No tasks</div>';
                    return;
                }
                
                container.innerHTML = tasks.map(task => `
                    <div class="task-item" data-task-id="${task.id}" data-day="${day}" draggable="true">
                        <div class="task-title ${task.completed ? 'completed' : ''}">${this.escapeHtml(task.title)}</div>
                        ${task.notes ? `<div class="task-notes">${this.escapeHtml(task.notes)}</div>` : ''}
                        
                        <div class="progress-container">
                            <div class="progress-label">${task.progress}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill ${task.completed ? 'completed' : ''}" 
                                     style="width: ${task.progress}%"></div>
                            </div>
                        </div>
                        
                        <div class="task-controls">
                            <input type="number" class="progress-input" min="0" max="100" 
                                   value="${task.progress}" placeholder="%" data-task-id="${task.id}" data-day="${day}">
                            <button class="btn btn-sm btn-progress" data-action="update-progress" data-task-id="${task.id}" data-day="${day}">Set</button>
                            <button class="btn btn-sm ${task.completed ? 'btn-incomplete' : 'btn-complete'}" 
                                    data-action="toggle-complete" data-task-id="${task.id}" data-day="${day}">
                                ${task.completed ? '↶' : '✓'}
                            </button>
                            <button class="btn btn-sm btn-copy" data-action="copy" data-task-id="${task.id}" data-day="${day}">⧉</button>
                            <button class="btn btn-sm btn-edit" data-action="edit" data-task-id="${task.id}" data-day="${day}">✎</button>
                            <button class="btn btn-sm btn-delete" data-action="delete" data-task-id="${task.id}" data-day="${day}">✗</button>
                        </div>
                        
                        <div class="edit-form" id="edit-${day}-${task.id}">
                            <input type="text" class="edit-title" value="${this.escapeHtml(task.title)}" placeholder="Task title">
                            <textarea class="edit-notes" placeholder="Add notes...">${this.escapeHtml(task.notes)}</textarea>
                            <div class="task-controls">
                                <button class="btn btn-save" data-action="save-edit" data-task-id="${task.id}" data-day="${day}">Save</button>
                                <button class="btn btn-cancel" data-action="cancel-edit" data-task-id="${task.id}" data-day="${day}">Cancel</button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                this.log(`Rendered ${tasks.length} tasks for ${day}`);
            }

            showEditForm(day, taskId) {
                document.getElementById(`edit-${day}-${taskId}`).style.display = 'block';
                this.log(`Edit form shown for ${day} task: ${taskId}`);
            }

            cancelEdit(day, taskId) {
                document.getElementById(`edit-${day}-${taskId}`).style.display = 'none';
                this.log(`Edit cancelled for ${day} task: ${taskId}`);
            }

            saveEdit(day, taskId) {
                const form = document.getElementById(`edit-${day}-${taskId}`);
                const title = form.querySelector('.edit-title').value;
                const notes = form.querySelector('.edit-notes').value;
                
                this.editTask(day, taskId, title, notes);
                form.style.display = 'none';
            }

            confirmDelete(day, taskId) {
                this.log(`Delete clicked for ${day} task: ${taskId}`);
                
                // Simple double-click delete - much cleaner UX
                const button = document.querySelector(`button[data-action="delete"][data-task-id="${taskId}"]`);
                if (!button) {
                    this.log(`Button not found, direct delete`);
                    this.deleteTask(day, taskId);
                    return;
                }
                
                // Check if this is already in "confirm mode"
                if (button.classList.contains('delete-confirm')) {
                    // Second click - delete the task
                    this.log(`Confirmation click - deleting task`);
                    this.deleteTask(day, taskId);
                    return;
                }
                
                // First click - enter confirm mode
                this.log(`First click - entering confirm mode`);
                button.classList.add('delete-confirm');
                button.style.backgroundColor = '#ff4757';
                button.textContent = '✓?';
                button.title = 'Click again to confirm deletion';
                
                // Auto-reset after 3 seconds if no second click
                setTimeout(() => {
                    if (button.classList.contains('delete-confirm')) {
                        button.classList.remove('delete-confirm');
                        button.style.backgroundColor = '';
                        button.textContent = '✗';
                        button.title = '';
                        this.log(`Delete confirmation timeout - reset button`);
                    }
                }, 3000);
            }

            deleteTaskDirectly(day, taskId) {
                // Remove this function as we don't need it anymore
                this.deleteTask(day, taskId);
            }

            attachTaskEventListeners() {
                // Remove existing listeners to prevent duplicates
                const existingListener = this.taskEventListener;
                if (existingListener) {
                    document.removeEventListener('click', existingListener);
                }
                
                // Create new event listener
                this.taskEventListener = (e) => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const action = button.dataset.action;
                    const taskId = button.dataset.taskId;
                    const day = button.dataset.day;
                    
                    this.log(`Button clicked: ${action} for task ${taskId} on ${day}`);
                    
                    switch (action) {
                        case 'add-task':
                            this.addTask(day);
                            break;
                        case 'copy':
                            this.startCopyMode(day, taskId);
                            break;
                        case 'delete':
                            this.confirmDelete(day, taskId);
                            break;
                        case 'toggle-complete':
                            this.toggleComplete(day, taskId);
                            break;
                        case 'edit':
                            this.showEditForm(day, taskId);
                            break;
                        case 'save-edit':
                            this.saveEdit(day, taskId);
                            break;
                        case 'cancel-edit':
                            this.cancelEdit(day, taskId);
                            break;
                        case 'update-progress':
                            const progressInput = button.parentElement.querySelector('.progress-input');
                            if (progressInput) {
                                this.updateProgress(day, taskId, progressInput.value);
                            }
                            break;
                        default:
                            this.log(`Unknown action: ${action}`);
                    }
                };
                
                // Attach the event listener
                document.addEventListener('click', this.taskEventListener);
                
                // Add day column click handler for copy mode
                this.dayClickListener = (e) => {
                    if (this.copyMode && e.target.closest('.day-column')) {
                        const dayColumn = e.target.closest('.day-column');
                        const targetDay = dayColumn.dataset.day;
                        
                        // Don't allow copying to the same day
                        if (targetDay === this.copyMode.day) {
                            this.log(`Cannot copy to same day: ${targetDay}`);
                            return;
                        }
                        
                        // Perform the copy
                        this.copyTaskToDay(targetDay);
                        e.stopPropagation();
                    }
                };
                
                document.addEventListener('click', this.dayClickListener);
                this.log('Task event listeners attached');
            }

            startCopyMode(day, taskId) {
                this.log(`Starting copy mode for task ${taskId} from ${day}`);
                
                const weekKey = this.getWeekKey();
                const task = this.tasks[weekKey]?.[day]?.find(t => t.id === taskId);
                
                if (!task) {
                    this.log(`Task not found: ${taskId} in ${day}`);
                    return;
                }
                
                // Set copy mode state
                this.copyMode = {
                    taskId: taskId,
                    day: day,
                    taskData: { ...task } // Deep copy of task data
                };
                
                // Update UI for copy mode
                document.body.classList.add('copy-mode');
                
                // Highlight the copy button
                const copyButton = document.querySelector(`button[data-action="copy"][data-task-id="${taskId}"]`);
                if (copyButton) {
                    copyButton.classList.add('copying');
                    copyButton.textContent = '↻';
                }
                
                // Mark source day
                const sourceColumn = document.querySelector(`.day-${day}`);
                if (sourceColumn) {
                    sourceColumn.classList.add('copy-source');
                }
                
                // Add escape key handler
                this.copyModeEscapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        this.exitCopyMode();
                    }
                };
                document.addEventListener('keydown', this.copyModeEscapeHandler);
                
                this.log(`Copy mode active. Task data:`, this.copyMode.taskData);
            }

            copyTaskToDay(targetDay) {
                this.log(`Copying task to ${targetDay}`);
                
                if (!this.copyMode) {
                    this.log(`Error: Not in copy mode`);
                    return;
                }
                
                const weekKey = this.getWeekKey();
                if (!this.tasks[weekKey]) {
                    this.tasks[weekKey] = {};
                    this.days.forEach(d => this.tasks[weekKey][d] = []);
                }
                
                if (!this.tasks[weekKey][targetDay]) {
                    this.tasks[weekKey][targetDay] = [];
                }
                
                // Create new task with copied data
                const copiedTask = {
                    ...this.copyMode.taskData,
                    id: Date.now().toString(), // New unique ID
                    createdAt: new Date().toISOString() // Update creation time
                };
                
                this.tasks[weekKey][targetDay].push(copiedTask);
                
                // Auto-expand target day
                this.expandDay(targetDay);
                
                // Save and update UI
                this.saveTasks();
                this.renderTasksForDay(targetDay);
                this.updateTaskCount(targetDay);
                
                this.log(`Task copied successfully from ${this.copyMode.day} to ${targetDay}`, copiedTask);
                
                // Exit copy mode
                this.exitCopyMode();
                
                // Provide user feedback
                this.showCopySuccess(targetDay);
            }

            exitCopyMode() {
                this.log(`Exiting copy mode`);
                
                if (!this.copyMode) return;
                
                // Remove UI changes
                document.body.classList.remove('copy-mode');
                
                // Reset copy button
                const copyButton = document.querySelector(`button[data-action="copy"][data-task-id="${this.copyMode.taskId}"]`);
                if (copyButton) {
                    copyButton.classList.remove('copying');
                    copyButton.textContent = '⧉';
                }
                
                // Remove source day marking
                const sourceColumn = document.querySelector(`.day-${this.copyMode.day}`);
                if (sourceColumn) {
                    sourceColumn.classList.remove('copy-source');
                }
                
                // Remove escape handler
                if (this.copyModeEscapeHandler) {
                    document.removeEventListener('keydown', this.copyModeEscapeHandler);
                    this.copyModeEscapeHandler = null;
                }
                
                this.copyMode = null;
                this.log(`Copy mode exited`);
            }

            showCopySuccess(targetDay) {
                const indicator = document.getElementById('copyModeIndicator');
                if (indicator) {
                    indicator.textContent = `✓ Task copied to ${this.dayNames[targetDay]}`;
                    indicator.style.display = 'block';
                    indicator.style.backgroundColor = '#27ae60';
                    
                    setTimeout(() => {
                        indicator.style.display = 'none';
                        indicator.style.backgroundColor = 'rgba(0,0,0,0.8)';
                        indicator.textContent = 'Click on a day to copy the task there';
                    }, 2000);
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new TodoApp();
        });
    </script>
</body>
</html>